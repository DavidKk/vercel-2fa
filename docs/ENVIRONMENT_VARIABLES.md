# Environment Variables Configuration

This document describes all environment variables used in the Two-Factor Authentication Service.

## Required Variables

### ACCESS_USERNAME

- **Description**: Administrator username for login
- **Required**: Yes
- **Example**: `admin`

### ACCESS_PASSWORD

- **Description**: Administrator password for login
- **Required**: Yes
- **Example**: `your-secure-password`
- **Note**: Use a strong password in production

### JWT_SECRET

- **Description**: Secret key for JWT token signing
- **Required**: Yes
- **Minimum Length**: 32 characters recommended
- **Example**: `your-super-secret-jwt-key-minimum-32-characters-long`
- **Security**: Keep this secret secure and never expose it

## Two-Factor Authentication (At least one required)

### ACCESS_TOTP_SECRET

- **Description**: TOTP (Time-based One-Time Password) secret for 2FA
- **Required**: Optional (but at least one 2FA method must be configured)
- **Format**: Base32 encoded string
- **Example**: `JBSWY3DPEHPK3PXP`
- **Generation**: Can be generated using the `/totp` page

### ACCESS_WEBAUTHN_SECRET

- **Description**: WebAuthn credentials for biometric/hardware key authentication
- **Required**: Optional (but at least one 2FA method must be configured)
- **Format**: JSON string containing credential data
- **Example**: `{"id":"...","publicKey":"...","rpId":"..."}`
- **Generation**: Can be generated using the `/webauthn` page

## Optional Variables

### JWT_EXPIRES_IN

- **Description**: JWT token expiration time
- **Required**: No
- **Default**: `30d` (30 days)
- **Format**: String with time unit (s=seconds, m=minutes, h=hours, d=days)
- **Examples**:
  - `5m` - 5 minutes
  - `1h` - 1 hour
  - `7d` - 7 days
  - `30d` - 30 days

### ALLOWED_REDIRECT_URLS

- **Description**: Whitelist of allowed redirect URLs for third-party login integration
- **Required**: No (if not set, only relative paths are allowed)
- **Format**: Comma-separated list of URLs
- **Supports**: Wildcard patterns using `*`
- **Examples**:
  ```
  https://app1.example.com,https://app2.example.com,http://localhost:3000
  ```
  ```
  https://*.example.com,https://*.company.com
  ```
- **Wildcard Patterns**:
  - `https://*.example.com` - Matches any subdomain of example.com
  - `https://app-*.example.com` - Matches app-1.example.com, app-2.example.com, etc.

### ENABLE_TOKEN_REPLAY_PROTECTION

- **Description**: Enable token replay protection using Vercel KV to prevent token reuse attacks
- **Required**: No (default: disabled)
- **Values**: `1`, `true` (enabled) or `0`, `false`, unset (disabled)
- **Requirements**:
  - Requires `@vercel/kv` package to be installed
  - Requires Vercel KV to be configured in your Vercel project
- **How it works**:
  - Tracks used JWT IDs (jti) in Vercel KV
  - Prevents the same token from being used multiple times
  - **Auto-Expiration**: Vercel KV automatically expires keys when TTL is reached (no manual cleanup needed)
  - Token TTL: 3 minutes (180 seconds) - tokens are short-lived for login verification only, allows sufficient time for normal login flow (20-60 seconds) with buffer for network delays and user retries
  - KV TTL: 190 seconds (180s token + 10s buffer) - ensures tracking slightly longer than token expiration
- **Free Tier Limits**:
  - Vercel KV free tier: 30,000 requests/month, 256MB storage
  - Sufficient for small to medium teams (< 200 users, < 500 logins/day)
  - **Storage Efficiency**: With 3-minute TTL, only ~20-50 active tokens are stored at any time
- **Example**: `ENABLE_TOKEN_REPLAY_PROTECTION=1`
- **Note**: If enabled but Vercel KV is not configured, the service will fail open (allow tokens) to prevent blocking legitimate requests

### ECDH_SERVER_PRIVATE_KEY

- **Description**: Server's ECDH private key for secure key exchange (ECDH flow)
- **Required**: Required if using ECDH-encrypted OAuth flow
- **Format**: PEM-encoded private key (PKCS#8 format)
- **Example**: Generated by visiting `/ecdh` page or `node scripts/generate-ecdh-keys.mjs`
- **Security**: Keep this secret secure and never expose it
- **Generation**: Visit `/ecdh` page to generate a key pair
- **Note**: This is the only key required for production. The public keys are only needed for debugging.

### ECDH_SERVER_PUBLIC_KEY

- **Description**: Server's ECDH public key for secure key exchange (ECDH flow) - server-side use
- **Required**: Optional (debugging only, not required for production)
- **Format**: PEM-encoded public key (SPKI format)
- **Example**: Generated by visiting `/ecdh` page
- **Note**: This is the server-side PEM format, used internally. Only needed for local debugging and testing.
- **Generation**: Visit `/ecdh` page to generate a key pair
- **Production**: Not required - only the private key is needed for production. The public key is shared with clients separately.

### ENABLE_KEY_ROTATION

- **Description**: Enable automatic ECDH key pair rotation using Vercel KV
- **Required**: No (default: disabled)
- **Values**: `1`, `true` (enabled) or `0`, `false`, unset (disabled)
- **Requirements**:
  - Requires `@vercel/kv` package to be installed
  - Requires Vercel KV to be configured in your Vercel project
- **How it works**:
  - Automatically rotates server ECDH key pairs before expiration
  - Stores multiple key pairs in Vercel KV during transition period
  - Ensures smooth key rotation without breaking active sessions
  - Keys are automatically rotated when they approach expiration (within transition period)
- **Benefits**:
  - Enhanced security through regular key rotation
  - No manual intervention required
  - Graceful transition with overlap period for active sessions
- **Example**: `ENABLE_KEY_ROTATION=1`
- **Note**: If enabled but Vercel KV is not configured, the service will fall back to environment variable keys

### KEY_ROTATION_TTL_SECONDS

- **Description**: Time to live (TTL) for each ECDH key pair in seconds
- **Required**: No (only used when `ENABLE_KEY_ROTATION=1`)
- **Default**: `604800` (7 days)
- **Format**: Number of seconds
- **Example**: `604800` (7 days), `2592000` (30 days)
- **Note**: Each key pair is valid for this duration before expiration. Keys are automatically rotated before expiration.

### KEY_ROTATION_TRANSITION_SECONDS

- **Description**: Transition period in seconds for key rotation overlap
- **Required**: No (only used when `ENABLE_KEY_ROTATION=1`)
- **Default**: `86400` (1 day)
- **Format**: Number of seconds
- **Example**: `86400` (1 day), `172800` (2 days)
- **Note**: During the transition period, both old and new keys are active. This ensures smooth key rotation without breaking active sessions. The system will attempt decryption with all active keys.

### KV_REST_API_URL

- **Description**: Vercel KV REST API URL (automatically provided by Vercel)
- **Required**: Yes (only when using `ENABLE_KEY_ROTATION=1` or `ENABLE_TOKEN_REPLAY_PROTECTION=1`)
- **How to get**: Automatically set by Vercel when you add KV integration to your project
- **Setup** (通过 Vercel Storage/Marketplace):
  1. Go to your Vercel project dashboard
  2. Navigate to the **"Storage"** tab
  3. Click **"Create Database"** or **"Add"**
  4. **选择 "KV"** (如果直接有 KV 选项) 或 **"Upstash" → "Serverless DB (Redis)"**
  5. Vercel KV 基于 Upstash Redis，所以选择 **"Upstash"** 下的 **"Serverless DB (Redis)"** 也可以
  6. 创建后，Vercel 会自动注入 `KV_REST_API_URL` 和 `KV_REST_API_TOKEN` 环境变量
  7. **重要**: 添加后必须重新部署应用，环境变量才会生效
- **Alternative**: 也可以通过 **"Integrations"** 标签页添加 KV 集成
- **Note**:
  - Vercel KV 是基于 Upstash Redis 的封装服务
  - 如果看到 "KV" 选项，直接选择它
  - 如果没有 "KV" 选项，选择 "Upstash" → "Serverless DB (Redis)" 也可以
  - 不需要手动设置这些变量，Vercel 会自动配置

### KV_REST_API_TOKEN

- **Description**: Vercel KV REST API authentication token (automatically provided by Vercel)
- **Required**: Yes (only when using `ENABLE_KEY_ROTATION=1` or `ENABLE_TOKEN_REPLAY_PROTECTION=1`)
- **How to get**: Automatically set by Vercel when you add KV integration to your project
- **Setup**: Same as `KV_REST_API_URL` - automatically configured when you add the KV integration through Integrations or Marketplace
- **Security**: This token is automatically managed by Vercel and should never be manually set or exposed
- **Note**: You don't need to manually set this variable. It's automatically configured by Vercel when you add the KV integration.

### NEXT_PUBLIC_BUILD_TIME

- **Description**: Build timestamp (auto-generated)
- **Required**: No
- **Note**: Automatically set during build process, do not modify manually

## Configuration Examples

### Development Environment

```bash
# .env.local
# Required Variables
ACCESS_USERNAME=admin
ACCESS_PASSWORD=dev-password-123
JWT_SECRET=dev-jwt-secret-key-minimum-32-chars

# Two-Factor Authentication (at least one required)
ACCESS_TOTP_SECRET=JBSWY3DPEHPK3PXP
# ACCESS_WEBAUTHN_SECRET={"id":"...","publicKey":"...","rpId":"..."}

# Optional Configuration
JWT_EXPIRES_IN=1h
ALLOWED_REDIRECT_URLS=http://localhost:3000,http://localhost:3001

# ECDH Key Exchange (OAuth Flow)
ECDH_SERVER_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n"
ECDH_SERVER_PUBLIC_KEY="-----BEGIN PUBLIC KEY-----\n...\n-----END PUBLIC KEY-----\n"
NEXT_PUBLIC_ECDH_SERVER_PUBLIC_KEY="base64-encoded-spki-format-public-key"

# Token Replay Protection (Optional)
# ENABLE_TOKEN_REPLAY_PROTECTION=0

# Key Rotation (Optional, requires Vercel KV)
# ENABLE_KEY_ROTATION=0
# KEY_ROTATION_TTL_SECONDS=604800
# KEY_ROTATION_TRANSITION_SECONDS=86400
```

### Production Environment (Vercel)

Configure these in your Vercel project settings:

```bash
# Required Variables
ACCESS_USERNAME=admin
ACCESS_PASSWORD=your-strong-secure-password-here
JWT_SECRET=your-production-jwt-secret-min-32-characters

# Two-Factor Authentication (at least one required)
ACCESS_TOTP_SECRET=YOUR_PRODUCTION_TOTP_SECRET
ACCESS_WEBAUTHN_SECRET={"id":"...","publicKey":"..."}

# Optional Configuration
JWT_EXPIRES_IN=30d
ALLOWED_REDIRECT_URLS=https://app.yourcompany.com,https://dashboard.yourcompany.com,https://*.yourcompany.com

# ECDH Key Exchange (OAuth Flow)
ECDH_SERVER_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n"

# Token Replay Protection (Recommended for production)
ENABLE_TOKEN_REPLAY_PROTECTION=1

# Key Rotation (Recommended for production, requires Vercel KV)
ENABLE_KEY_ROTATION=1
KEY_ROTATION_TTL_SECONDS=604800
KEY_ROTATION_TRANSITION_SECONDS=86400
```

## Security Best Practices

1. **Never commit sensitive values**: Use `.env.local` for local development and keep it out of version control
2. **Use strong secrets**: Generate cryptographically secure random strings for `JWT_SECRET`
3. **Rotate secrets regularly**: Especially for production environments
4. **Limit redirect URLs**: Only add trusted domains to `ALLOWED_REDIRECT_URLS`
5. **Use environment-specific configs**: Different values for dev, staging, and production
6. **Secure storage**: Use secure secret management services (e.g., Vercel Secrets, AWS Secrets Manager)

## Generating Secure Secrets

### Generate JWT_SECRET

```bash
# Using Node.js
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"

# Using OpenSSL
openssl rand -hex 32
```

### Generate TOTP Secret

Visit the `/totp` page in the application to generate a TOTP secret and QR code.

### Generate WebAuthn Secret

Visit the `/webauthn` page in the application to register a WebAuthn credential.

### Generate ECDH Key Pair

Visit the `/ecdh` page in the application to generate an ECDH key pair. The generator will show:

1. **Private Key (PEM Format)** - Required for production, store in `ECDH_SERVER_PRIVATE_KEY`
2. **Public Key (PEM Format)** - Only needed for debugging, store in `ECDH_SERVER_PUBLIC_KEY`

**Important**: For production, only the private key (`ECDH_SERVER_PRIVATE_KEY`) is required. The public key is automatically shared with clients via the `/api/oauth/public-key` endpoint. The `ECDH_SERVER_PUBLIC_KEY` is only needed for local debugging and testing.

## Troubleshooting

### "2FA is not enabled" Error

- Ensure at least one of `ACCESS_TOTP_SECRET` or `ACCESS_WEBAUTHN_SECRET` is configured

### "Invalid server configuration" Error

- Check that `JWT_SECRET` is set and has sufficient length
- Verify that required environment variables are properly configured

### "Invalid Redirect URL" Error

- The redirect URL is not in the `ALLOWED_REDIRECT_URLS` whitelist
- Add the URL to the whitelist or use a relative path

### JWT Token Verification Fails

- Ensure `JWT_SECRET` matches between auth service and client applications
- Check that the token has not expired
- Verify the token format is correct

### "Missing required environment variables KV_REST_API_URL and KV_REST_API_TOKEN" Error

This error occurs when `ENABLE_KEY_ROTATION=1` or `ENABLE_TOKEN_REPLAY_PROTECTION=1` is set, but Vercel KV is not configured.

**Solutions:**

1. **If you want to use KV features** (recommended for production):

   - Go to your Vercel project dashboard
   - Navigate to the **"Storage"** tab
   - Click **"Create Database"** or **"Add"**
   - **选择 "KV"** (推荐，如果可用) 或 **"Upstash" → "Serverless DB (Redis)"**
   - 注意：Vercel KV 基于 Upstash Redis，所以选择 Upstash Redis 也可以
   - 创建后，Vercel 会自动注入 `KV_REST_API_URL` 和 `KV_REST_API_TOKEN`
   - **重要**: 添加后必须重新部署应用，环境变量才会生效
   - 验证变量是否设置：Settings → Environment Variables，确认两个变量都存在
   - **Alternative**: 也可以通过 **"Integrations"** 标签页搜索 "KV" 添加集成

2. **If you don't want to use KV features**:
   - Set `ENABLE_KEY_ROTATION=0` or remove it (defaults to disabled)
   - Set `ENABLE_TOKEN_REPLAY_PROTECTION=0` or remove it (defaults to disabled)
   - The service will fall back to using environment variable keys

**Note**: The code has been updated to gracefully handle missing KV configuration. If KV is not available, the service will automatically fall back to environment variable keys without throwing errors.

**Troubleshooting Tips:**

- If you added KV but still see the error, make sure you **redeployed** your application after adding the integration
- Check that the integration is actually connected to your project in the Integrations tab
- Verify environment variables exist in Settings → Environment Variables (they should be automatically added by Vercel)

## References

- [Next.js Environment Variables](https://nextjs.org/docs/basic-features/environment-variables)
- [Vercel Environment Variables](https://vercel.com/docs/concepts/projects/environment-variables)
- [Vercel KV Documentation](https://vercel.com/docs/storage/vercel-kv)
- [JWT Best Practices](https://tools.ietf.org/html/rfc8725)
